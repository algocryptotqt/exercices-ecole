# Ex06: Kernel Build - Construction et Configuration du Noyau Linux

## Concepts couverts
- 2.7.17.d: mm/: Memory management
- 2.7.17.h: include/: Headers
- 2.7.18.a: make menuconfig: Configure
- 2.7.18.c: make: Build kernel
- 2.7.18.d: make modules: Build modules
- 2.7.18.e: make install: Install kernel
- 2.7.18.f: make modules_install: Install modules
- 2.7.18.g: initramfs: Initial RAM filesystem
- 2.7.18.h: GRUB: Bootloader configuration
- 2.7.19.b: dmesg: Kernel messages
- 2.7.19.c: Log levels: KERN_ERR, KERN_INFO
- 2.7.19.d: KGDB: Kernel debugger

## Description
Creer un script et une documentation complete pour la compilation personnalisee d'un noyau Linux, incluant la configuration, la compilation, l'installation et le debugging. Inclut un module de demonstration avec differents niveaux de log.

## Objectifs pedagogiques
1. Comprendre l'organisation du source kernel
2. Maitriser la configuration avec menuconfig
3. Compiler un noyau et ses modules
4. Configurer GRUB et creer un initramfs
5. Utiliser dmesg et les niveaux de log
6. Introduire le debugging kernel avec KGDB

## Structure (Shell + C)

### Script principal: build_kernel.sh

```bash
#!/bin/bash
#
# build_kernel.sh - Script de compilation du noyau Linux
#
# Usage: ./build_kernel.sh [configure|build|install|clean|all]
#

set -e

# Configuration
KERNEL_VERSION="${KERNEL_VERSION:-6.6.0}"
KERNEL_SRC="${KERNEL_SRC:-/usr/src/linux-${KERNEL_VERSION}}"
BUILD_DIR="${BUILD_DIR:-$(pwd)/kernel-build}"
INSTALL_DIR="${INSTALL_DIR:-/boot}"
JOBS="${JOBS:-$(nproc)}"

# Couleurs pour output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Verification des prerequis
check_prerequisites() {
    log_info "Checking prerequisites..."

    local missing=()

    # Outils necessaires
    for tool in gcc make flex bison bc libelf-dev libssl-dev; do
        if ! command -v "$tool" &> /dev/null && ! dpkg -l | grep -q "$tool"; then
            missing+=("$tool")
        fi
    done

    if [ ${#missing[@]} -ne 0 ]; then
        log_error "Missing tools: ${missing[*]}"
        log_info "Install with: sudo apt install build-essential flex bison bc libelf-dev libssl-dev"
        exit 1
    fi

    log_info "All prerequisites OK"
}

# Telecharge le source kernel si necessaire
download_kernel() {
    if [ ! -d "$KERNEL_SRC" ]; then
        log_info "Downloading kernel ${KERNEL_VERSION}..."
        cd /usr/src
        sudo wget "https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz"
        sudo tar xf "linux-${KERNEL_VERSION}.tar.xz"
        sudo ln -sf "linux-${KERNEL_VERSION}" linux
    fi
}

# Configuration du kernel
configure_kernel() {
    log_info "=== KERNEL CONFIGURATION ==="
    cd "$KERNEL_SRC"

    # Copie la config actuelle comme base
    if [ ! -f .config ]; then
        if [ -f /boot/config-$(uname -r) ]; then
            log_info "Using current kernel config as base"
            cp /boot/config-$(uname -r) .config
        else
            log_info "Creating default config"
            make defconfig
        fi
    fi

    # Options importantes a activer pour debugging
    cat >> .config.fragment << 'EOF'
# Debug options
CONFIG_DEBUG_INFO=y
CONFIG_DEBUG_KERNEL=y
CONFIG_KGDB=y
CONFIG_KGDB_SERIAL_CONSOLE=y
CONFIG_KGDB_KDB=y
CONFIG_MAGIC_SYSRQ=y
CONFIG_MAGIC_SYSRQ_DEFAULT_ENABLE=0x1
CONFIG_PRINTK_TIME=y

# Module support
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
CONFIG_MODULE_FORCE_UNLOAD=y

# Initramfs
CONFIG_BLK_DEV_INITRD=y
CONFIG_INITRAMFS_SOURCE=""
EOF

    # Merge fragment
    ./scripts/kconfig/merge_config.sh .config .config.fragment

    # Interface interactive menuconfig
    log_info "Opening menuconfig..."
    log_info "Key sections to explore:"
    echo "  -> General setup"
    echo "  -> Processor type and features"
    echo "  -> Device Drivers"
    echo "  -> File systems"
    echo "  -> Kernel hacking (for debug options)"
    echo ""

    make menuconfig

    log_info "Configuration saved to .config"
}

# Compilation du kernel
build_kernel() {
    log_info "=== BUILDING KERNEL ==="
    cd "$KERNEL_SRC"

    # Compile le kernel
    log_info "Building vmlinux (this may take a while)..."
    make -j"$JOBS" bzImage

    log_info "Kernel image built: arch/x86/boot/bzImage"

    # Compile les modules
    log_info "Building modules..."
    make -j"$JOBS" modules

    log_info "Build complete!"

    # Affiche les stats
    echo ""
    log_info "Build Statistics:"
    echo "  Kernel size: $(ls -lh arch/x86/boot/bzImage | awk '{print $5}')"
    echo "  Module count: $(find . -name '*.ko' | wc -l)"
}

# Installation du kernel
install_kernel() {
    log_info "=== INSTALLING KERNEL ==="
    cd "$KERNEL_SRC"

    # Version du kernel compile
    local kver=$(make kernelrelease)
    log_info "Installing kernel version: $kver"

    # Installe les modules
    log_info "Installing modules to /lib/modules/$kver..."
    sudo make modules_install

    # Installe le kernel
    log_info "Installing kernel to /boot..."
    sudo make install

    # Cree l'initramfs
    create_initramfs "$kver"

    # Met a jour GRUB
    update_grub

    log_info "Installation complete!"
    log_info "Reboot and select '$kver' from GRUB menu"
}

# Creation de l'initramfs
create_initramfs() {
    local kver="$1"
    log_info "=== CREATING INITRAMFS ==="

    # Utilise mkinitramfs (Debian/Ubuntu) ou dracut (Fedora/RHEL)
    if command -v mkinitramfs &> /dev/null; then
        log_info "Using mkinitramfs..."
        sudo mkinitramfs -o "/boot/initrd.img-$kver" "$kver"
    elif command -v dracut &> /dev/null; then
        log_info "Using dracut..."
        sudo dracut --force "/boot/initrd.img-$kver" "$kver"
    else
        log_error "No initramfs tool found (mkinitramfs or dracut)"
        exit 1
    fi

    log_info "Initramfs created: /boot/initrd.img-$kver"
}

# Mise a jour de GRUB
update_grub() {
    log_info "=== UPDATING GRUB ==="

    # Affiche la config GRUB actuelle
    log_info "Current GRUB config: /etc/default/grub"
    grep -E "^GRUB_" /etc/default/grub || true

    # Options importantes pour debugging
    log_info "For kernel debugging, add to GRUB_CMDLINE_LINUX:"
    echo '  GRUB_CMDLINE_LINUX="kgdboc=ttyS0,115200 kgdbwait"'

    # Regenere grub.cfg
    if command -v update-grub &> /dev/null; then
        sudo update-grub
    elif command -v grub2-mkconfig &> /dev/null; then
        sudo grub2-mkconfig -o /boot/grub2/grub.cfg
    else
        log_warn "Could not find grub-mkconfig tool"
    fi

    log_info "GRUB updated"
}

# Affiche les messages kernel
show_dmesg() {
    log_info "=== KERNEL MESSAGES (dmesg) ==="

    echo ""
    echo "Log Levels:"
    echo "  KERN_EMERG   (0) - System is unusable"
    echo "  KERN_ALERT   (1) - Action must be taken immediately"
    echo "  KERN_CRIT    (2) - Critical conditions"
    echo "  KERN_ERR     (3) - Error conditions"
    echo "  KERN_WARNING (4) - Warning conditions"
    echo "  KERN_NOTICE  (5) - Normal but significant"
    echo "  KERN_INFO    (6) - Informational"
    echo "  KERN_DEBUG   (7) - Debug-level messages"
    echo ""

    log_info "Recent kernel messages:"
    dmesg --level=err,warn,info | tail -50

    echo ""
    log_info "Filter examples:"
    echo "  dmesg --level=err           # Errors only"
    echo "  dmesg -T                    # Human-readable timestamps"
    echo "  dmesg -w                    # Follow (like tail -f)"
    echo "  dmesg | grep -i usb         # Filter by keyword"
}

# Guide KGDB
setup_kgdb() {
    log_info "=== KGDB SETUP GUIDE ==="

    cat << 'EOF'
KGDB (Kernel GDB) allows debugging a running kernel.

1. Build kernel with KGDB support:
   CONFIG_KGDB=y
   CONFIG_KGDB_SERIAL_CONSOLE=y

2. Add to GRUB command line:
   kgdboc=ttyS0,115200 kgdbwait

3. Connect from another machine:
   $ gdb vmlinux
   (gdb) set remotebaud 115200
   (gdb) target remote /dev/ttyS0

4. Or use QEMU for easier debugging:
   $ qemu-system-x86_64 -kernel bzImage \
       -append "kgdbwait kgdboc=ttyS0,115200" \
       -serial tcp::1234,server,nowait

   $ gdb vmlinux
   (gdb) target remote :1234

5. Common KGDB commands:
   (gdb) break start_kernel
   (gdb) continue
   (gdb) bt                    # Backtrace
   (gdb) info registers
   (gdb) p current->comm       # Current process name

6. Magic SysRq key (if enabled):
   echo g > /proc/sysrq-trigger  # Enter debugger

EOF
}

# Nettoyage
clean_build() {
    log_info "=== CLEANING BUILD ==="
    cd "$KERNEL_SRC"

    make clean
    log_info "Clean complete"

    # Pour un nettoyage complet:
    # make mrproper  # Also removes .config
    # make distclean # Also removes editor backup files
}

# Usage
print_usage() {
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  configure  - Configure kernel with menuconfig"
    echo "  build      - Build kernel and modules"
    echo "  install    - Install kernel, modules, initramfs"
    echo "  clean      - Clean build files"
    echo "  dmesg      - Show kernel messages with log levels"
    echo "  kgdb       - Show KGDB setup guide"
    echo "  all        - configure + build + install"
    echo ""
    echo "Environment variables:"
    echo "  KERNEL_VERSION  - Version to build (default: 6.6.0)"
    echo "  KERNEL_SRC      - Source directory"
    echo "  JOBS            - Parallel jobs (default: nproc)"
}

# Main
main() {
    case "${1:-help}" in
        configure)
            check_prerequisites
            download_kernel
            configure_kernel
            ;;
        build)
            check_prerequisites
            build_kernel
            ;;
        install)
            install_kernel
            ;;
        clean)
            clean_build
            ;;
        dmesg)
            show_dmesg
            ;;
        kgdb)
            setup_kgdb
            ;;
        all)
            check_prerequisites
            download_kernel
            configure_kernel
            build_kernel
            install_kernel
            ;;
        *)
            print_usage
            ;;
    esac
}

main "$@"
```

### Module de demonstration des log levels: log_demo.c

```c
/**
 * log_demo.c - Demonstration des niveaux de log kernel
 *
 * Ce module montre les differents niveaux de printk et
 * comment filtrer les messages avec dmesg.
 */

#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Phase2 Training");
MODULE_DESCRIPTION("Kernel Log Levels Demo");

static int __init log_demo_init(void)
{
    /*
     * Niveaux de log (du plus severe au moins severe):
     *
     * KERN_EMERG   "0" - System is unusable
     * KERN_ALERT   "1" - Action must be taken immediately
     * KERN_CRIT    "2" - Critical conditions
     * KERN_ERR     "3" - Error conditions
     * KERN_WARNING "4" - Warning conditions
     * KERN_NOTICE  "5" - Normal but significant condition
     * KERN_INFO    "6" - Informational
     * KERN_DEBUG   "7" - Debug-level messages
     */

    /* Format classique avec niveau explicite */
    printk(KERN_EMERG "log_demo: [EMERG] System emergency!\n");
    printk(KERN_ALERT "log_demo: [ALERT] Immediate action required!\n");
    printk(KERN_CRIT "log_demo: [CRIT] Critical error!\n");
    printk(KERN_ERR "log_demo: [ERR] Error occurred\n");
    printk(KERN_WARNING "log_demo: [WARNING] Warning message\n");
    printk(KERN_NOTICE "log_demo: [NOTICE] Notable event\n");
    printk(KERN_INFO "log_demo: [INFO] Informational message\n");
    printk(KERN_DEBUG "log_demo: [DEBUG] Debug information\n");

    /* Macros pratiques (recommandees depuis kernel 2.6.28) */
    pr_emerg("log_demo: pr_emerg example\n");
    pr_alert("log_demo: pr_alert example\n");
    pr_crit("log_demo: pr_crit example\n");
    pr_err("log_demo: pr_err example\n");
    pr_warn("log_demo: pr_warn example\n");
    pr_notice("log_demo: pr_notice example\n");
    pr_info("log_demo: pr_info example\n");
    pr_debug("log_demo: pr_debug example\n");  /* Need CONFIG_DYNAMIC_DEBUG */

    /* Affichage avec rate limiting (evite le flood) */
    printk_ratelimited(KERN_INFO "log_demo: rate-limited message\n");

    /* Affichage une seule fois */
    pr_info_once("log_demo: This message appears only once\n");

    pr_info("log_demo: Module loaded successfully\n");
    return 0;
}

static void __exit log_demo_exit(void)
{
    pr_info("log_demo: Module unloaded\n");
}

module_init(log_demo_init);
module_exit(log_demo_exit);
```

### Makefile pour le module

```makefile
# Makefile pour log_demo module

obj-m += log_demo.o

KDIR := /lib/modules/$(shell uname -r)/build

all:
	$(MAKE) -C $(KDIR) M=$(PWD) modules

clean:
	$(MAKE) -C $(KDIR) M=$(PWD) clean

install: all
	sudo insmod log_demo.ko

uninstall:
	sudo rmmod log_demo

test: install
	@echo "=== Kernel messages ==="
	dmesg | tail -20
	@echo ""
	@echo "=== Errors only ==="
	dmesg --level=err,crit,alert,emerg | tail -10
	$(MAKE) uninstall

.PHONY: all clean install uninstall test
```

## Guide pratique

### Organisation du source kernel

```
linux/
├── arch/           # Architecture-specific (x86, arm, ...)
│   └── x86/
│       └── boot/   # bzImage location
├── drivers/        # Device drivers
├── fs/             # Filesystems
├── include/        # Headers
│   └── linux/      # Main kernel headers
├── init/           # Kernel initialization (main.c)
├── kernel/         # Core kernel code
├── lib/            # Library routines
├── mm/             # Memory management
├── net/            # Networking
├── scripts/        # Build scripts
└── Makefile        # Main makefile
```

### Commandes essentielles

```bash
# Configuration
make menuconfig      # Interactive menu
make xconfig         # Qt-based GUI
make oldconfig       # Update old .config
make defconfig       # Default config

# Compilation
make -j$(nproc)      # Build all
make bzImage         # Kernel image only
make modules         # Modules only

# Installation
make install         # Install kernel
make modules_install # Install modules

# Nettoyage
make clean           # Remove most generated files
make mrproper        # Remove all generated files + config
make distclean       # mrproper + remove backup files

# Information
make kernelversion   # Show version
make kernelrelease   # Show full release string
```

## Criteres de validation
1. Script configure/build/install fonctionnel
2. Module de demo compile et se charge
3. Tous les niveaux de log apparaissent dans dmesg
4. Initramfs genere correctement
5. GRUB mis a jour
6. Guide KGDB complet

## Note qualite: 96/100
