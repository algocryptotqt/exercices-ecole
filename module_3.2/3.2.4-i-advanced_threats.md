# Exercice 3.2.09 : advanced_threats

**Module :**
3.2.4 â€” Network Attacks

**Concept :**
i â€” Advanced Threat Analysis (IPv6, BGP, SSL Strip, Rogue AP, C2, DGA)

**Difficulte :**
â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜† (9/10)

**Type :**
complet

**Tiers :**
2 â€” Melange (concepts i + j + k + l + m + n + o)

**Langage :**
Rust Edition 2024

**Prerequis :**
- 3.2.08 (Layer 2 Havoc)
- IPv6 fundamentals
- C2 communication patterns

**Domaines :**
Net, Crypto, Algo

**Duree estimee :**
8-10 heures

**XP Base :**
450

**Complexite :**
T4 O(nÂ²) Ã— S3 O(n log n)

---

## ğŸ“ SECTION 1 : PROTOTYPE & CONSIGNE

### 1.2 Consigne

**ğŸ® CONTEXTE : "Westworld" - Behavior Analysis System**

*"Dans Westworld, Delos Corporation analyse les comportements des hosts pour detecter les deviants. Tu developpes un systeme similaire pour le reseau : analyser les patterns de communication pour identifier les menaces avancees.*

*Les attaquants modernes utilisent des techniques sophistiquees : IPv6 pour contourner les defenses, DGA pour leurs C2, SSL stripping pour intercepter le trafic. Ton analyseur doit detecter ces comportements 'deviants' du reseau."*

---

**Ta mission :**

Implementer `advanced_threats` qui:

1. **Detecte le beaconing C2** (analyse frequence, jitter)
2. **Identifie les DGA** (Domain Generation Algorithm) via entropie
3. **Detecte les anomalies IPv6** (RA spoofing, NDP attacks)
4. **Analyse les patterns industriels suspects** (Modbus, DNP3)
5. **Genere un threat report** avec TTPs (MITRE ATT&CK mapping)

---

**Entree :**

```json
{
  "analysis_window": {
    "start": "2026-01-10T00:00:00Z",
    "end": "2026-01-10T23:59:59Z"
  },
  "network_events": [
    {
      "timestamp": "2026-01-10T10:00:00Z",
      "src_ip": "192.168.1.100",
      "dst_ip": "198.51.100.50",
      "dst_port": 443,
      "bytes": 256,
      "protocol": "TCP"
    }
  ],
  "dns_queries": [
    {
      "timestamp": "2026-01-10T10:00:01Z",
      "query": "xkcd9f8a7b6c5d4e3f.evil.com",
      "query_type": "A",
      "response": "198.51.100.50"
    }
  ],
  "ipv6_events": [
    {
      "timestamp": "2026-01-10T11:00:00Z",
      "event_type": "router_advertisement",
      "source_mac": "AA:BB:CC:DD:EE:FF",
      "source_ip": "fe80::1",
      "prefix": "2001:db8::/64",
      "router_lifetime": 1800
    }
  ],
  "industrial_traffic": [
    {
      "timestamp": "2026-01-10T12:00:00Z",
      "protocol": "modbus",
      "function_code": 6,
      "unit_id": 1,
      "register_address": 100,
      "value": 9999
    }
  ]
}
```

---

**Sortie :**

```json
{
  "threats_detected": [
    {
      "threat_id": "THR-001",
      "threat_type": "c2_beaconing",
      "severity": "critical",
      "confidence": 0.92,
      "description": "Regular beaconing pattern detected to 198.51.100.50",
      "evidence": {
        "beacon_interval_seconds": 60,
        "jitter_percent": 5,
        "samples_analyzed": 1440,
        "destination": "198.51.100.50:443"
      },
      "iocs": {
        "ip": "198.51.100.50",
        "domain": "evil.com",
        "user_agent": null
      },
      "mitre_mapping": {
        "tactic": "Command and Control",
        "technique": "T1071.001",
        "description": "Application Layer Protocol: Web Protocols"
      }
    },
    {
      "threat_id": "THR-002",
      "threat_type": "dga_detected",
      "severity": "high",
      "confidence": 0.88,
      "evidence": {
        "domain_pattern": "*.evil.com",
        "entropy_average": 4.8,
        "unique_subdomains": 156,
        "sample_domains": ["xkcd9f8a7b6c5d4e3f", "a1b2c3d4e5f6g7h8"]
      }
    }
  ],
  "ttp_summary": {
    "initial_access": [],
    "execution": [],
    "persistence": [],
    "command_and_control": ["T1071.001", "T1568.002"],
    "exfiltration": []
  },
  "risk_assessment": {
    "overall_risk": "critical",
    "compromised_hosts": ["192.168.1.100"],
    "active_c2": true,
    "data_exfiltration_risk": "high"
  }
}
```

---

### 1.3 Prototype

```rust
/// Point d'entree principal
pub fn analyze_advanced_threats(input: &ThreatInput) -> ThreatReport;

/// Detecte les patterns de beaconing C2
pub fn detect_c2_beaconing(
    events: &[NetworkEvent],
    tolerance_percent: f64
) -> Vec<BeaconingThreat>;

/// Detecte les DGA via analyse d'entropie
pub fn detect_dga(queries: &[DnsQuery]) -> Vec<DgaThreat>;

/// Detecte les attaques IPv6
pub fn detect_ipv6_attacks(events: &[Ipv6Event]) -> Vec<Ipv6Threat>;

/// Analyse le trafic industriel suspect
pub fn analyze_industrial_traffic(
    traffic: &[IndustrialEvent]
) -> Vec<IndustrialThreat>;

/// Mappe les menaces aux TTPs MITRE ATT&CK
pub fn map_to_mitre(threats: &[Threat]) -> TtpSummary;
```

---

## âœ…âŒ SECTION 4 : ZONE CORRECTION

### 4.1 Moulinette

| Test ID | Description | Points |
|---------|-------------|--------|
| `T01` | Detect beaconing 60s interval | 15 |
| `T02` | Detect beaconing with jitter | 10 |
| `T03` | Detect DGA entropy | 15 |
| `T04` | Distinguish DGA from CDN | 10 |
| `T05` | Detect IPv6 RA spoofing | 10 |
| `T06` | Detect NDP flooding | 5 |
| `T07` | Detect Modbus write abuse | 10 |
| `T08` | MITRE mapping correct | 10 |
| `T09` | Handle normal traffic | 10 |
| `T10` | Risk assessment accurate | 5 |

**Total : 100 points**

---

### 4.3 Solution de reference (extraits)

```rust
pub fn detect_c2_beaconing(
    events: &[NetworkEvent],
    tolerance_percent: f64
) -> Vec<BeaconingThreat> {
    let mut threats = Vec::new();

    // Group by src/dst pair
    let mut connections: HashMap<(String, String, u16), Vec<&NetworkEvent>> = HashMap::new();
    for event in events {
        let key = (event.src_ip.clone(), event.dst_ip.clone(), event.dst_port);
        connections.entry(key).or_default().push(event);
    }

    for ((src, dst, port), conn_events) in connections {
        if conn_events.len() < 10 {
            continue; // Need enough samples
        }

        // Sort by timestamp
        let mut sorted: Vec<_> = conn_events.iter().collect();
        sorted.sort_by_key(|e| &e.timestamp);

        // Calculate intervals
        let mut intervals: Vec<f64> = Vec::new();
        for i in 1..sorted.len() {
            let delta = (sorted[i].timestamp - sorted[i-1].timestamp)
                .num_milliseconds() as f64 / 1000.0;
            intervals.push(delta);
        }

        if intervals.is_empty() {
            continue;
        }

        // Calculate statistics
        let mean = intervals.iter().sum::<f64>() / intervals.len() as f64;
        let variance = intervals.iter()
            .map(|x| (x - mean).powi(2))
            .sum::<f64>() / intervals.len() as f64;
        let std_dev = variance.sqrt();
        let jitter_percent = (std_dev / mean * 100.0) as u32;

        // Beaconing detection: low jitter + regular interval > 30s
        if jitter_percent <= tolerance_percent as u32 && mean >= 30.0 {
            threats.push(BeaconingThreat {
                threat_type: ThreatType::C2Beaconing,
                severity: Severity::Critical,
                confidence: calculate_beacon_confidence(jitter_percent, sorted.len()),
                evidence: BeaconingEvidence {
                    beacon_interval_seconds: mean as u64,
                    jitter_percent,
                    samples_analyzed: sorted.len(),
                    destination: format!("{}:{}", dst, port),
                    source: src.clone(),
                },
                mitre_mapping: MitreMapping {
                    tactic: "Command and Control".to_string(),
                    technique: "T1071.001".to_string(),
                    description: "Application Layer Protocol: Web Protocols".to_string(),
                },
            });
        }
    }

    threats
}

pub fn detect_dga(queries: &[DnsQuery]) -> Vec<DgaThreat> {
    let mut threats = Vec::new();
    let mut domain_stats: HashMap<String, DomainAnalysis> = HashMap::new();

    for query in queries {
        let base_domain = extract_base_domain(&query.query);
        let subdomain = extract_subdomain(&query.query);

        let stats = domain_stats.entry(base_domain.clone()).or_default();
        stats.query_count += 1;

        if let Some(sub) = subdomain {
            let entropy = calculate_entropy(&sub);
            stats.subdomains.push(sub.clone());
            stats.entropies.push(entropy);
        }
    }

    // Known CDN domains to whitelist
    let cdn_whitelist = ["cloudflare.com", "akamai.net", "amazonaws.com"];

    for (domain, stats) in domain_stats {
        if cdn_whitelist.iter().any(|cdn| domain.ends_with(cdn)) {
            continue;
        }

        if stats.entropies.is_empty() {
            continue;
        }

        let avg_entropy = stats.entropies.iter().sum::<f64>() / stats.entropies.len() as f64;
        let unique_subs: HashSet<_> = stats.subdomains.iter().collect();

        // DGA indicators: high entropy + many unique subdomains
        if avg_entropy > 4.5 && unique_subs.len() > 20 {
            threats.push(DgaThreat {
                threat_type: ThreatType::DgaDetected,
                severity: Severity::High,
                confidence: calculate_dga_confidence(avg_entropy, unique_subs.len()),
                evidence: DgaEvidence {
                    domain_pattern: format!("*.{}", domain),
                    entropy_average: avg_entropy,
                    unique_subdomains: unique_subs.len(),
                    sample_domains: stats.subdomains.iter().take(5).cloned().collect(),
                },
            });
        }
    }

    threats
}

fn calculate_entropy(data: &str) -> f64 {
    if data.is_empty() {
        return 0.0;
    }

    let mut freq: HashMap<char, usize> = HashMap::new();
    for c in data.chars() {
        *freq.entry(c).or_insert(0) += 1;
    }

    let len = data.len() as f64;
    freq.values()
        .map(|&count| {
            let p = count as f64 / len;
            -p * p.log2()
        })
        .sum()
}
```

---

## ğŸ§  SECTION 5 : COMPRENDRE (extraits)

### 5.3 Visualisation ASCII

```
C2 BEACONING DETECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Time series analysis:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
     â–¼    â–¼    â–¼    â–¼    â–¼    â–¼    â–¼    â–¼    â–¼    â–¼
â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â”€
     60s  60s  60s  60s  60s  60s  60s  60s  60s

Mean interval: 60 seconds
Jitter: 3% (Â±1.8s)
Confidence: 0.95 â†’ HIGH CONFIDENCE C2 BEACONING


DGA DETECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•

Normal DNS:                    DGA-generated:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
www.google.com                 xkcd9f8a7b.evil.com
mail.google.com                a1b2c3d4e5.evil.com
docs.google.com                z9y8x7w6v5.evil.com
    â”‚                              â”‚
    â”‚                              â”‚
    â–¼                              â–¼
Entropy: ~3.5                  Entropy: ~4.8
Predictable                    Random/algorithmic


MITRE ATT&CK MAPPING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TACTIC: Command and Control                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  T1071.001 - Web Protocols (HTTP/HTTPS C2)          â”‚
â”‚  â”œâ”€â”€ Beaconing to port 443                          â”‚
â”‚  â””â”€â”€ Regular interval communication                 â”‚
â”‚                                                     â”‚
â”‚  T1568.002 - Domain Generation Algorithms           â”‚
â”‚  â”œâ”€â”€ High entropy domains                           â”‚
â”‚  â””â”€â”€ Rapidly changing C2 infrastructure             â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.8 Mnemotechniques

#### ğŸ¬ MEME : "Westworld - These violent delights have violent ends"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  "The maze isn't meant for you" - C2 Communication             â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”„ BEACONING = "The loop"                                     â”‚
â”‚     â†’ Comportement repetitif, previsible                       â”‚
â”‚     â†’ Intervalle regulier = host compromis                     â”‚
â”‚                                                                 â”‚
â”‚  ğŸ² DGA = "The reveries"                                       â”‚
â”‚     â†’ Domaines generes algorithmiquement                       â”‚
â”‚     â†’ Entropie elevee = comportement "deviant"                 â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“¡ IPv6 RA Spoofing = "Ford's backdoor"                       â”‚
â”‚     â†’ Controle invisible de l'infrastructure                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ SECTION 9 : DEPLOYMENT PACK

```json
{
  "deploy": {
    "hackbrain_version": "5.5.2",
    "exercise_slug": "3.2.4-i-advanced-threats",
    "metadata": {
      "exercise_id": "3.2.09",
      "exercise_name": "advanced_threats",
      "module": "3.2.4",
      "module_name": "Network Attacks",
      "difficulty": 9,
      "language": "rust",
      "xp_base": 450,
      "tags": ["c2", "dga", "ipv6", "beaconing", "mitre", "threat-hunting"]
    }
  }
}
```

---

*HACKBRAIN v5.5.2 â€” Advanced Threats*
*"Traquer les comportements deviants du reseau"*