# Exercice 3.2.07 : encrypted_insights

**Module :**
3.2.3 â€” Traffic Analysis

**Concept :**
e â€” TLS & DNS Forensics (TLS handshakes, DNS tunneling, certificates, IoCs)

**Difficulte :**
â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜†â˜†â˜† (7/10)

**Type :**
complet

**Tiers :**
2 â€” Melange (concepts e + f + i + j)

**Langage :**
Rust Edition 2024

**Prerequis :**
- 3.2.06 (Packet Surgeon)
- Module 3.1 (Cryptographie - TLS)
- DNS protocol basics

**Domaines :**
Net, Crypto, Algo

**Duree estimee :**
5-6 heures

**XP Base :**
300

**Complexite :**
T2 O(n) Ã— S2 O(n)

---

## ğŸ“ SECTION 1 : PROTOTYPE & CONSIGNE

### 1.1 Obligations

**Fichiers a rendre :**
```
encrypted_insights/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs
â”‚   â”œâ”€â”€ lib.rs
â”‚   â”œâ”€â”€ tls/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ handshake.rs
â”‚   â”‚   â””â”€â”€ certificate.rs
â”‚   â”œâ”€â”€ dns/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ parser.rs
â”‚   â”‚   â””â”€â”€ tunneling.rs
â”‚   â””â”€â”€ analyzer/
â”‚       â”œâ”€â”€ mod.rs
â”‚       â””â”€â”€ ioc_extractor.rs
```

**Fonctions autorisees :**
- `serde`, `serde_json`
- `base64` pour decodage
- `sha2` pour fingerprints

**Fonctions interdites :**
- Bibliotheques TLS reelles
- Acces reseau

---

### 1.2 Consigne

**ğŸ® CONTEXTE : "Dark" - Temporal Network Analysis**

*"Dans la serie Dark, les evenements se repetent selon des cycles. Tu es un analyste du groupe Sic Mundus qui doit etudier les communications chiffrees pour comprendre les patterns temporels.*

*Le trafic TLS cache des secrets. Les requetes DNS pourraient contenir des messages dissimules. Ton outil doit percer ces mysteres en analysant les handshakes, en validant les certificats, et en detectant le DNS tunneling."*

---

**Ta mission :**

Implementer `encrypted_insights` qui:

1. **Analyse les handshakes TLS** (versions, cipher suites, extensions)
2. **Valide les certificats** (expiration, self-signed, CN mismatch)
3. **Detecte le DNS tunneling** (entropie, query patterns, TXT records)
4. **Extrait les IoCs** (Indicators of Compromise)
5. **Calcule des scores de suspicion** par session

---

**Entree :**

```json
{
  "capture_metadata": {
    "timestamp": "2026-01-10T12:00:00Z",
    "duration_minutes": 60
  },
  "tls_sessions": [
    {
      "session_id": "sess_001",
      "client_ip": "192.168.1.100",
      "server_ip": "104.16.132.229",
      "server_name": "cloudflare.com",
      "handshake": {
        "client_hello": {
          "tls_version": "TLS 1.3",
          "cipher_suites": [
            "TLS_AES_256_GCM_SHA384",
            "TLS_CHACHA20_POLY1305_SHA256"
          ],
          "extensions": ["server_name", "supported_versions", "key_share"],
          "supported_groups": ["x25519", "secp256r1"]
        },
        "server_hello": {
          "tls_version": "TLS 1.3",
          "cipher_suite": "TLS_AES_256_GCM_SHA384"
        }
      },
      "certificate_chain": [
        {
          "subject": "CN=cloudflare.com",
          "issuer": "CN=DigiCert TLS RSA SHA256 2020 CA1",
          "serial": "0A:1B:2C:3D:4E:5F",
          "not_before": "2025-01-01T00:00:00Z",
          "not_after": "2026-06-01T00:00:00Z",
          "san": ["cloudflare.com", "*.cloudflare.com"],
          "fingerprint_sha256": "AABBCCDD..."
        }
      ],
      "bytes_transferred": 15234
    }
  ],
  "dns_queries": [
    {
      "timestamp": "2026-01-10T12:00:05Z",
      "client_ip": "192.168.1.100",
      "query_name": "www.example.com",
      "query_type": "A",
      "response": {
        "answers": [
          {"type": "A", "data": "93.184.216.34", "ttl": 300}
        ]
      }
    },
    {
      "timestamp": "2026-01-10T12:05:00Z",
      "client_ip": "192.168.1.100",
      "query_name": "aGVsbG8gd29ybGQK.data.evil.com",
      "query_type": "TXT",
      "response": {
        "answers": [
          {"type": "TXT", "data": "dGhpcyBpcyBhIHNlY3JldA==", "ttl": 60}
        ]
      }
    }
  ]
}
```

---

**Sortie :**

```json
{
  "analysis_metadata": {
    "analyzer": "encrypted_insights",
    "tls_sessions_analyzed": 45,
    "dns_queries_analyzed": 1523
  },
  "tls_analysis": [
    {
      "session_id": "sess_001",
      "security_assessment": {
        "tls_version": "TLS 1.3",
        "version_rating": "excellent",
        "cipher_strength": "strong",
        "forward_secrecy": true
      },
      "certificate_validation": {
        "valid": true,
        "issues": [],
        "days_until_expiry": 142
      },
      "risk_score": 5
    }
  ],
  "dns_analysis": {
    "tunneling_candidates": [
      {
        "domain": "data.evil.com",
        "evidence": {
          "high_entropy_subdomains": true,
          "entropy_score": 4.2,
          "base64_detected": true,
          "unusual_query_types": ["TXT"],
          "query_frequency": 12,
          "unique_subdomains": 45
        },
        "confidence": 0.92,
        "decoded_data": "hello world"
      }
    ],
    "statistics": {
      "total_queries": 1523,
      "unique_domains": 234,
      "query_types": {"A": 1200, "AAAA": 200, "TXT": 123}
    }
  },
  "iocs": [
    {
      "type": "domain",
      "value": "evil.com",
      "context": "DNS tunneling destination",
      "confidence": "high"
    },
    {
      "type": "ip",
      "value": "192.168.1.100",
      "context": "DNS tunneling source",
      "confidence": "high"
    }
  ],
  "risk_summary": {
    "high_risk_sessions": 2,
    "dns_tunneling_detected": true,
    "certificate_issues": 0,
    "recommendations": [
      "Investigate DNS traffic to evil.com",
      "Block or monitor data exfiltration"
    ]
  }
}
```

---

**Contraintes :**

- Calculer l'entropie Shannon pour detecter le tunneling
- Distinguer les CDN (haute entropie legitime) du tunneling malveillant
- Valider les chaines de certificats
- Detecter au moins 5 patterns de tunneling DNS

---

### 1.3 Prototype

```rust
/// Point d'entree principal
pub fn analyze_encrypted_traffic(input: &TrafficInput) -> AnalysisResult;

/// Analyse une session TLS
pub fn analyze_tls_session(session: &TlsSession) -> TlsAnalysis;

/// Valide une chaine de certificats
pub fn validate_certificate_chain(certs: &[Certificate]) -> CertValidation;

/// Detecte le DNS tunneling
pub fn detect_dns_tunneling(queries: &[DnsQuery]) -> Vec<TunnelingCandidate>;

/// Calcule l'entropie Shannon d'une chaine
pub fn calculate_entropy(data: &str) -> f64;

/// Extrait les IoCs
pub fn extract_iocs(
    tls: &[TlsAnalysis],
    dns: &DnsAnalysis
) -> Vec<IoC>;
```

---

## ğŸ’¡ SECTION 2 : LE SAVIEZ-VOUS ?

### 2.1 DNS Tunneling - L'exfiltration invisible

Le **DNS tunneling** exploite le fait que le DNS est rarement filtre. Les donnees sont encodees dans les subdomains (jusqu'a 63 caracteres par label, 253 total).

Outils celebres : **iodine**, **dnscat2**, **dns2tcp**

### 2.2 Entropie et detection

L'**entropie Shannon** mesure le "desordre" d'une chaine:
- Texte anglais normal : ~4.0 bits/char
- Base64 : ~5.7 bits/char
- Random : ~8.0 bits/char

Un subdomain avec entropie > 4.5 est suspect.

### 2.3 Le piege des CDNs

Les CDNs (Cloudflare, Akamai) utilisent des subdomains a haute entropie pour le load balancing. Ne pas confondre avec du tunneling !

---

## ğŸ¢ SECTION 2.5 : DANS LA VRAIE VIE

### Threat Intelligence Analyst
- Analyse les certificats pour identifier les infrastructures malveillantes
- Correle les fingerprints de certificats avec les campagnes connues

### SOC Analyst
- Detecte les tentatives d'exfiltration via DNS
- Identifie les communications C2 chiffrees

### Forensic Analyst
- Reconstitue les communications meme sans dechiffrement
- Extrait les metadonnees TLS (SNI, timestamps)

---

## ğŸ–¥ï¸ SECTION 3 : EXEMPLE D'UTILISATION

### 3.0 Session bash

```bash
$ cargo build --release

$ ./target/release/encrypted_insights --input captures/tls_dns.json
{
  "analysis_metadata": {
    "tls_sessions_analyzed": 45,
    "dns_queries_analyzed": 1523
  },
  "dns_analysis": {
    "tunneling_candidates": [
      {"domain": "data.evil.com", "confidence": 0.92}
    ]
  },
  "risk_summary": {
    "dns_tunneling_detected": true
  }
}

$ cargo test
running 30 tests
test tls::certificate::test_validate_chain ... ok
test dns::tunneling::test_entropy_calculation ... ok
test dns::tunneling::test_base64_detection ... ok
...
test result: ok. 30 passed; 0 failed
```

---

## âœ…âŒ SECTION 4 : ZONE CORRECTION

### 4.1 Moulinette

| Test ID | Description | Points |
|---------|-------------|--------|
| `T01` | Parse TLS session | 5 |
| `T02` | TLS 1.3 rating | 5 |
| `T03` | TLS 1.0 deprecation warning | 5 |
| `T04` | Certificate validation valid | 10 |
| `T05` | Certificate expired detection | 10 |
| `T06` | Self-signed detection | 10 |
| `T07` | Entropy calculation correct | 10 |
| `T08` | DNS tunneling base64 | 15 |
| `T09` | CDN false positive handling | 10 |
| `T10` | IoC extraction | 10 |
| `T11` | TXT record analysis | 10 |

**Total : 100 points**

---

### 4.3 Solution de reference (extraits)

```rust
pub fn calculate_entropy(data: &str) -> f64 {
    if data.is_empty() {
        return 0.0;
    }

    let mut freq: HashMap<char, usize> = HashMap::new();
    for c in data.chars() {
        *freq.entry(c).or_insert(0) += 1;
    }

    let len = data.len() as f64;
    let mut entropy = 0.0;

    for count in freq.values() {
        let p = *count as f64 / len;
        if p > 0.0 {
            entropy -= p * p.log2();
        }
    }

    entropy
}

pub fn detect_dns_tunneling(queries: &[DnsQuery]) -> Vec<TunnelingCandidate> {
    let mut candidates = Vec::new();

    // Group by base domain
    let mut domain_stats: HashMap<String, DomainStats> = HashMap::new();

    for query in queries {
        let base_domain = extract_base_domain(&query.query_name);
        let subdomain = extract_subdomain(&query.query_name);

        let stats = domain_stats.entry(base_domain.clone()).or_default();
        stats.query_count += 1;
        stats.query_types.insert(query.query_type.clone());

        if let Some(sub) = subdomain {
            stats.subdomains.insert(sub.clone());
            let entropy = calculate_entropy(&sub);
            stats.max_entropy = stats.max_entropy.max(entropy);
            stats.entropy_sum += entropy;
            stats.entropy_count += 1;

            // Check for base64 patterns
            if looks_like_base64(&sub) {
                stats.base64_count += 1;
            }
        }
    }

    // Analyze each domain
    for (domain, stats) in domain_stats {
        let avg_entropy = if stats.entropy_count > 0 {
            stats.entropy_sum / stats.entropy_count as f64
        } else {
            0.0
        };

        // Skip known CDNs
        if is_known_cdn(&domain) {
            continue;
        }

        let mut evidence = TunnelingEvidence::default();
        let mut confidence = 0.0;

        // High entropy subdomains
        if avg_entropy > 4.5 {
            evidence.high_entropy_subdomains = true;
            evidence.entropy_score = avg_entropy;
            confidence += 0.3;
        }

        // Base64 detected
        if stats.base64_count > 5 {
            evidence.base64_detected = true;
            confidence += 0.3;
        }

        // Unusual query types (TXT, NULL, CNAME abuse)
        if stats.query_types.contains("TXT") || stats.query_types.contains("NULL") {
            evidence.unusual_query_types = stats.query_types.iter().cloned().collect();
            confidence += 0.2;
        }

        // Many unique subdomains
        if stats.subdomains.len() > 20 {
            evidence.unique_subdomains = stats.subdomains.len();
            confidence += 0.2;
        }

        if confidence > 0.5 {
            candidates.push(TunnelingCandidate {
                domain,
                evidence,
                confidence: confidence.min(1.0),
                decoded_data: None, // Try to decode in separate pass
            });
        }
    }

    candidates
}

fn looks_like_base64(s: &str) -> bool {
    // Base64 uses A-Za-z0-9+/= with length multiple of 4
    let base64_chars = s.chars().all(|c| {
        c.is_ascii_alphanumeric() || c == '+' || c == '/' || c == '=' || c == '-' || c == '_'
    });

    // Check for base64-like patterns
    base64_chars && s.len() >= 8 && calculate_entropy(s) > 4.0
}

fn is_known_cdn(domain: &str) -> bool {
    let cdn_domains = [
        "cloudflare.com", "akamai.net", "cloudfront.net",
        "fastly.net", "edgecastcdn.net", "azureedge.net",
        "googleusercontent.com", "amazonaws.com"
    ];

    cdn_domains.iter().any(|cdn| domain.ends_with(cdn))
}
```

---

### 4.10 Solutions Mutantes

**Mutant A (Logic) : Entropie inversee**
```rust
// BUG: Plus l'entropie est basse, plus c'est suspect
if avg_entropy < 4.5 { // Devrait etre > 4.5
    evidence.high_entropy_subdomains = true;
}
```

**Mutant B (Safety) : Division par zero**
```rust
// BUG: Pas de check pour entropy_count == 0
let avg_entropy = stats.entropy_sum / stats.entropy_count as f64; // CRASH si 0
```

**Mutant C (False Positive) : Pas de CDN whitelist**
```rust
// BUG: Flag tous les CDNs comme tunneling
// Manque: if is_known_cdn(&domain) { continue; }
```

**Mutant D (Return) : Confidence non bornee**
```rust
// BUG: Confidence peut depasser 1.0
confidence: confidence, // Devrait etre confidence.min(1.0)
```

**Mutant E (Boundary) : Seuil d'entropie trop bas**
```rust
// BUG: Trop de faux positifs
if avg_entropy > 2.0 { // Devrait etre 4.5
```

---

## ğŸ§  SECTION 5 : COMPRENDRE (extraits)

### 5.3 Visualisation ASCII

```
DNS TUNNELING DETECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Normal DNS:                         DNS Tunneling:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
www.example.com                     aGVsbG8gd29ybGQK.data.evil.com
mail.example.com                    dGhpcyBpcyBhIHRlc3Q.data.evil.com
api.example.com                     c2VjcmV0IGRhdGEgaGVyZQ.data.evil.com
                                    â†‘
Entropy: ~3.5 bits/char             Entropy: ~5.7 bits/char (BASE64!)


TLS CERTIFICATE VALIDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CERTIFICATE CHAIN                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚   ROOT CA           â”‚ â† Trusted (in browser store)           â”‚
â”‚  â”‚   DigiCert Root     â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚             â”‚ Signs                                             â”‚
â”‚             â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚   INTERMEDIATE      â”‚ â† Sent by server                       â”‚
â”‚  â”‚   DigiCert TLS CA   â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚             â”‚ Signs                                             â”‚
â”‚             â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚   LEAF CERTIFICATE  â”‚ â† Server's certificate                 â”‚
â”‚  â”‚   CN=cloudflare.com â”‚                                        â”‚
â”‚  â”‚   SAN=*.cloudflare  â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                 â”‚
â”‚  VALIDATION CHECKS:                                             â”‚
â”‚  âœ“ Chain links to trusted root                                  â”‚
â”‚  âœ“ All signatures valid                                         â”‚
â”‚  âœ“ Not expired (NotBefore < now < NotAfter)                     â”‚
â”‚  âœ“ CN/SAN matches requested hostname                            â”‚
â”‚  âœ“ No revocation (CRL/OCSP)                                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.8 Mnemotechniques

#### ğŸŒ€ MEME : "Dark - Everything is connected"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  "Alles ist miteinander verbunden"                              â”‚
â”‚  (Everything is connected)                                      â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”„ ENTROPY RULES:                                              â”‚
â”‚                                                                 â”‚
â”‚  > 4.5 bits/char = "The loop is closing"                       â”‚
â”‚                    (Something suspicious is happening)          â”‚
â”‚                                                                 â”‚
â”‚  TXT records avec base64 = "The passage is open"               â”‚
â”‚                            (Data is being exfiltrated)          â”‚
â”‚                                                                 â”‚
â”‚  CDN traffic = "Different timeline"                            â”‚
â”‚                (Legitimate high entropy, don't flag it)         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ SECTION 9 : DEPLOYMENT PACK

```json
{
  "deploy": {
    "hackbrain_version": "5.5.2",
    "exercise_slug": "3.2.3-e-encrypted-insights",
    "metadata": {
      "exercise_id": "3.2.07",
      "exercise_name": "encrypted_insights",
      "module": "3.2.3",
      "module_name": "Traffic Analysis",
      "difficulty": 7,
      "language": "rust",
      "xp_base": 300,
      "tags": ["tls", "dns", "tunneling", "forensics", "certificates"]
    }
  }
}
```

---

*HACKBRAIN v5.5.2 â€” Encrypted Insights*
*"Percer les secrets du trafic chiffre"*